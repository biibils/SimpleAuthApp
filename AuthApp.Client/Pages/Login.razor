@page "/login"
@inject HttpClient Http
@inject NavigationManager NavManager
@inject ILocalStorageService LocalStorage
@using AuthApp.Application.DTOs

<div style="max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px;">
    <h3>Login</h3>
    <hr />

    <div style="margin-bottom: 15px;">
        <label>Email:</label>
        <input type="email" @bind="loginModel.Email" class="form-control" style="width: 100%; padding: 8px;" />
    </div>

    <div style="margin-bottom: 15px;">
        <label>Password:</label>
        <input type="password" @bind="loginModel.Password" class="form-control" style="width: 100%; padding: 8px;" />
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div style="color: red; margin-bottom: 15px;">@errorMessage</div>
    }

    <button @onclick="SubmitLogin" disabled="@isLoggingIn" style="width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; cursor: pointer;">
        @(isLoggingIn ? "Loading..." : "Login")
    </button>
</div>

@code {
    private LoginRequest loginModel = new();
    private bool isLoggingIn = false;
    private string errorMessage = "";

    private async Task SubmitLogin()
    {
        errorMessage = "";
        isLoggingIn = true;

        try 
        {
            var result = await Http.PostAsJsonAsync("api/auth/login", loginModel);
            
            if (result.IsSuccessStatusCode)
            {
                var response = await result.Content.ReadFromJsonAsync<LoginResponse>();
                
                if (response != null && response.Success)
                {
                    await LocalStorage.SetItemAsync("authToken", response.Token);
                    NavManager.NavigateTo("/");
                }
                else
                {
                    errorMessage = response?.Message ?? "Login gagal.";
                }
            }
            else 
            {
                errorMessage = "Email atau Password salah (401/404).";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Koneksi ke server gagal.";
            Console.WriteLine(ex.Message);
        }
        finally 
        {
            isLoggingIn = false;
        }
    }
}